<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cronômetro com Armazenamento em SQL</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }

    .container {
      display: flex;
      width: 100%;
      max-width: 600px;
      margin: 20px 0;
      border: 1px solid #ccc;
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    .column {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }

    .button-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .button-row>button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      border: none;
      border-radius: 4px;
    }

    .button-row>button.start-btn {
      background-color: #4CAF50;
      color: #fff;
    }

    .button-row>button.stop-btn {
      background-color: #4CAF50;
      color: #fff;
    }

    .button-row>button.atendimento-btn {
      background-color: #4CAF50;
      color: #fff;
    }

    .timer {
      font-size: 20px;
      margin: 0 20px;
      width: 120px;
      text-align: center;
    }

    #data-output {
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    #data-output table {
      width: 100%;
      border-collapse: collapse;
    }

    #data-output th,
    #data-output td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    #data-output th {
      background-color: #eee;
    }

    #filters {
      margin: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    #filters label {
      margin: 5px 0;
    }

    #filters button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }

    #filters button:hover {
      background-color: #45a049;
    }
  </style>
</head>

<body>
  <h1>Cronômetro de Operações</h1>
  <div class="container">
    <div class="column">
      <!-- Botões Start, Atendimento e Stop com cronômetros -->
      <div id="button-timer-rows">
        <!-- Linhas de botões e cronômetros serão geradas aqui -->
      </div>
    </div>
  </div>

  <!-- Filtros para visualização dos dados -->
  <div id="filters">
    <label for="start-date">Data de Início:</label>
    <input type="date" id="start-date">
    <label for="end-date">Data de Fim:</label>
    <input type="date" id="end-date">
    <button id="view-data-button">Ver Dados Armazenados</button>
  </div>

  <!-- Botão para baixar os dados -->
  <button id="download-data-button">Download Dados em CSV</button>

  <div id="data-output">
    <!-- Dados armazenados serão exibidos aqui -->
  </div>

  <script>
    // Inicialização das variáveis globais
    const numTimers = 5; // Número de cronômetros e botões
    const timers = []; // Array para armazenar os cronômetros
    let db; // Variável para o banco de dados

    // Função para iniciar a IndexedDB
    function initDB() {
      let request = indexedDB.open('TimerDB', 1);

      request.onupgradeneeded = function (event) {
        db = event.target.result;
        let store = db.createObjectStore('timers', { keyPath: 'id', autoIncrement: true });
        store.createIndex('date', 'date', { unique: false });
      };

      request.onsuccess = function (event) {
        db = event.target.result;
      };

      request.onerror = function (event) {
        console.error('Erro ao iniciar o IndexedDB:', event.target.errorCode);
      };
    }

    // Função para armazenar os dados no IndexedDB
    function storeTimerData(timerData) {
      let transaction = db.transaction(['timers'], 'readwrite');
      let store = transaction.objectStore('timers');
      let request = store.add(timerData);

      request.onsuccess = function () {
        console.log('Dados armazenados com sucesso:', timerData);
      };

      request.onerror = function (event) {
        console.error('Erro ao armazenar dados:', event.target.errorCode);
      };
    }

    // Função para acessar os dados armazenados no IndexedDB com filtro de data
    function viewStoredData() {
      let transaction = db.transaction(['timers'], 'readonly');
      let store = transaction.objectStore('timers');
      let request = store.getAll();

      request.onsuccess = function (event) {
        let data = event.target.result;
        const startDate = new Date(document.getElementById('start-date').value);
        const endDate = new Date(document.getElementById('end-date').value);
        // Ajusta o endDate para incluir o fim do dia
        endDate.setHours(23, 59, 59, 999);

        if (startDate && endDate) {
          data = data.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= startDate && itemDate <= endDate;
          });
        }
        displayData(data);
      };

      request.onerror = function (event) {
        console.error('Erro ao acessar dados:', event.target.errorCode);
      };
    }

    // Função para exibir os dados na tela
    function displayData(data) {
      const output = document.getElementById('data-output');
      if (data.length > 0) {
        let html = '<table><tr><th>ID</th><th>Data</th><th>Botão</th><th>Tempo Primeiro Clique (min)</th><th>Tempo Segundo Clique (min)</th><th>Tempo Atendimento (min)</th></tr>';
        data.forEach(item => {
          const formattedDate = new Date(item.date).toLocaleString();
          html += `<tr><td>${item.id}</td><td>${formattedDate}</td><td>${item.buttonName}</td><td>${(item.elapsedTimeFirstClick / 60000).toFixed(2)}</td><td>${(item.elapsedTimeSecondClick / 60000).toFixed(2)}</td><td>${(item.elapsedTimeAtendimentoClick / 60000).toFixed(2)}</td></tr>`;
        });
        html += '</table>';
        output.innerHTML = html;
      } else {
        output.innerHTML = '<p>Nenhum dado armazenado.</p>';
      }
    }

    // Função para baixar os dados em formato CSV
    function downloadDataAsCSV(data) {
      let csvContent = "ID,Data,Botão,Tempo Primeiro Clique (min),Tempo Segundo Clique (min),Tempo Atendimento (min)\n";
      data.forEach(item => {
        const formattedDate = new Date(item.date).toLocaleString();
        csvContent += `${item.id},"${formattedDate}",${item.buttonName},${(item.elapsedTimeFirstClick / 60000).toFixed(2)},${(item.elapsedTimeSecondClick / 60000).toFixed(2)},${(item.elapsedTimeAtendimentoClick / 60000).toFixed(2)}\n`;
      });
      const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "dados_cronometros.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Função para iniciar o cronômetro
    function startTimer(index) {
      if (!timers[index].interval) {
        if (!timers[index].firstClickRecorded) {
          timers[index].startTimeFirstClick = Date.now();
          timers[index].buttonElement.style.backgroundColor = '#f44336'; // Muda a cor do botão Start para vermelho
          timers[index].firstClickRecorded = true;
        } else {
          timers[index].startTimeSecondClick = Date.now();
          timers[index].buttonElement.style.backgroundColor = '#008CBA'; // Muda a cor do botão Start para azul
          timers[index].secondClickRecorded = true;
        }

        timers[index].interval = setInterval(() => {
          const now = Date.now();
          if (timers[index].secondClickRecorded) {
            timers[index].elapsedTimeSecondClick = now - timers[index].startTimeSecondClick;
            timers[index].timerElement.textContent = (timers[index].elapsedTimeSecondClick / 1000).toFixed(2) + ' s';
          } else {
            timers[index].elapsedTimeFirstClick = now - timers[index].startTimeFirstClick;
            timers[index].timerElement.textContent = (timers[index].elapsedTimeFirstClick / 1000).toFixed(2) + ' s';
          }
        }, 100);
      }
    }

    // Função para parar o cronômetro
    function stopTimer(index) {
      clearInterval(timers[index].interval);
      timers[index].interval = null;
      timers[index].buttonElement.style.backgroundColor = '#4CAF50'; // Reseta a cor do botão Start para verde
      timers[index].stopButtonElement.style.backgroundColor = '#4CAF50'; // Reseta a cor do botão Stop para verde

      // Armazena os dados no IndexedDB
      const timerData = {
        date: new Date(),
        buttonName: `Start ${index + 1}`,
        elapsedTimeFirstClick: timers[index].elapsedTimeFirstClick,
        elapsedTimeSecondClick: timers[index].elapsedTimeSecondClick || 0, // Se não houve segundo clique, registra 0
        elapsedTimeAtendimentoClick: timers[index].elapsedTimeAtendimentoClick || 0 // Se não houve clique no botão Atendimento, registra 0
      };
      storeTimerData(timerData);

      // Reseta o cronômetro
      timers[index].elapsedTimeFirstClick = 0;
      timers[index].elapsedTimeSecondClick = 0;
      timers[index].elapsedTimeAtendimentoClick = 0;
      timers[index].firstClickRecorded = false;
      timers[index].secondClickRecorded = false;
      timers[index].timerElement.textContent = '0.00 s';
    }

    // Função para iniciar o cronômetro de atendimento
    function atendimentoTimer(index) {
      const now = Date.now();
      timers[index].startTimeAtendimentoClick = now;
      timers[index].buttonAtendimentoElement.style.backgroundColor = '#008CBA'; // Muda a cor do botão Atendimento para azul
      timers[index].interval = setInterval(() => {
        timers[index].elapsedTimeAtendimentoClick = Date.now() - timers[index].startTimeAtendimentoClick;
        timers[index].timerElement.textContent = (timers[index].elapsedTimeAtendimentoClick / 1000).toFixed(2) + ' s';
      }, 100);
    }

    // Função para criar os botões, cronômetros e eventos
    function createButtonTimerRows() {
      const container = document.getElementById('button-timer-rows');
      for (let i = 0; i < numTimers; i++) {
        const row = document.createElement('div');
        row.className = 'button-row';

        const startButton = document.createElement('button');
        startButton.className = 'start-btn';
        startButton.textContent = `Start ${i + 1}`;
        startButton.addEventListener('click', () => startTimer(i));

        const atendimentoButton = document.createElement('button');
        atendimentoButton.className = 'atendimento-btn';
        atendimentoButton.textContent = `Atendimento ${i + 1}`;
        atendimentoButton.addEventListener('click', () => atendimentoTimer(i));

        const stopButton = document.createElement('button');
        stopButton.className = 'stop-btn';
        stopButton.textContent = `Stop ${i + 1}`;
        stopButton.addEventListener('click', () => stopTimer(i));

        const timerDisplay = document.createElement('div');
        timerDisplay.className = 'timer';
        timerDisplay.textContent = '0.00 s';

        row.appendChild(startButton);
        row.appendChild(atendimentoButton);
        row.appendChild(timerDisplay);
        row.appendChild(stopButton);
        container.appendChild(row);

        timers.push({
          startTimeFirstClick: 0,
          startTimeSecondClick: 0,
          startTimeAtendimentoClick: 0,
          elapsedTimeFirstClick: 0,
          elapsedTimeSecondClick: 0,
          elapsedTimeAtendimentoClick: 0,
          interval: null,
          firstClickRecorded: false,
          secondClickRecorded: false,
          buttonElement: startButton,
          buttonAtendimentoElement: atendimentoButton,
          stopButtonElement: stopButton,
          timerElement: timerDisplay
        });
      }
    }

    // Inicializa a aplicação
    window.onload = function () {
      initDB();
      createButtonTimerRows();
      document.getElementById('view-data-button').addEventListener('click', viewStoredData);
      document.getElementById('download-data-button').addEventListener('click', function () {
        let transaction = db.transaction(['timers'], 'readonly');
        let store = transaction.objectStore('timers');
        let request = store.getAll();

        request.onsuccess = function (event) {
          downloadDataAsCSV(event.target.result);
        };

        request.onerror = function (event) {
          console.error('Erro ao acessar dados:', event.target.errorCode);
        };
      });
    };
  </script>
</body>

</html>
